# Тестовое задание на позицию стажёра-бэкендера Avito.Tech: микросервис для работы с балансом пользователей

## Для запуска приложения:

```
make compose-up
```
# Реализованные методы:

## **Метод получения баланса пользователя:** *принимает id пользователя.* <br/>
  Вызов: 
  ``` 
  GET /account/getBalance/:id
  ```

  Возвращаемый JSON: 
  ``` 
  { 
    "user-balance": int,
    "user-pending-amount": int
  } 
  ```
  
  ## **Метод начисления средств на баланс:** *принимает id пользователя и сколько средств зачислить. Возвращает баланс с двумя параметрами: настоящим балансом и кредитным. При вызове метода на несуществующий аккаунт создается запись с балансом суммы начисления и нулевым кредитным балансом (нулевым долгом).* <br/>
  Вызов: 
  ``` 
  POST /account/depositMoney 
  ```
  
  Принимаемый JSON: 
  ``` 
  {
    "user-id": int,
    "update-amount": int
  }
  ```
  Возвращаемый JSON: 
  ``` 
  { 
    "account-id": int,
    "sum-deposited": int, 
    "operation-status": string,
    "operation-event": string,
    "created-at": time.Time()
  } 
  ```
  ## Примечания: при начислении денег на несуществующий аккаунт создается новый счет с балансом, равным начисляемой сумме. Реализована проверка на отрицательную сумму пополнения </br>
  
  ## **Метод снятия средств с баланса:** *принимает id пользователя и сколько средств снять. Проверяет существование аккаунта и уход в отрицательный баланс.* <br/>
  Вызов: 
  ``` 
  POST /account/withdrawMoney 
  ```
  
  Принимаемый JSON: 
  ``` 
  {
    "user-id": int,
    "update-amount": int
  }
  ```
  Возвращаемый JSON: 
  ``` 
  { 
    "account-id": int,
    "sum-withdrawn": int, 
    "operation-status": string,
    "operation-event": string,
    "created-at": time.Time()
  } 
  ```
  ## Примечания: реализованы проверки на уход баланса в отрицательное число после снятия, отрицательную сумму снятия, существование пользователя с указанным идентификатором. </br>
## **Метод резервирования средств с основного баланса на отдельном счете:** *принимает id пользователя, ИД услуги, ИД заказа, стоимость. Записывает в отдельную таблицу полученные параметры вместе со статусом "Pending" и таймкодом получения. Увеличивает кредитный баланс пользователя на стоимость услуги. * <br/>
 Вызов: 
  ``` 
  POST /account/reserveServiceFee
  ```
  
  Принимаемый JSON: 
  ``` 
  {
    "user-id": int,
    "service-id": int,
    "order-id": int,
    "fee": int
  }
  ```
  Возвращаемый JSON: 
  ``` 
  { 
    "account-id": int
    "service-id": int
    "order-id":   int
    "invoice":    int
    "status":     string
    "created-at": time.Time(),
    "updated-at": time.Time()
  } 
  ```
 ## Примечания: реализованы проверки на отрицательную стоимость, существование пользователя с указанным идентификатором. </br>
 
 ## **Метод признания выручки:** *списывает из резерва деньги, добавляет данные в отчет для бухгалтерии.  Проверяет последний статус по услуге с принятыми параметрами на предмет конфликта (ранее установленный статус подтверждения "Approved" или статус отмены "Cancelled"), устанавливает статус записи с принятыми параметрами в "Approved", уменьшает кредитный баланс пользователя и пытается списать сумму со счета. В случае нехватки средств откатывает транзакцию и возвращает ошибку. Принимает id пользователя, ИД услуги, ИД заказа, сумму.* <br/>
 Вызов: 
  ``` 
  POST /account/approveServiceFee
  ```
  
  Принимаемый JSON: 
  ``` 
  {
    "user-id": int,
    "service-id": int,
    "order-id": int,
    "fee": int
  }
  ```
  Возвращаемый JSON: 
  ``` 
  { 
    "account-id": int
    "service-id": int
    "order-id":   int
    "invoice":    int
    "status":     string
    "created-at": time.Time(),
    "updated-at": time.Time()
  } 
  ```
 ## Примечания: реализованы проверки на уход баланса в отрицательное число после списания суммы, отрицательную сумму снятия, существование пользователя с указанным идентификатором, последний статус записи с теми же параметрами. </br>

 ## **Метод разрезервирования средств:** *разрезервирует услугу для пользователя. Проверяет последний статус по услуге с принятыми параметрами на предмет конфликта (ранее установленный статус подтверждения "Approved" или статус отмены "Cancelled") Устанавливает статус по услуге в "Cancelled", уменьшает кредитный баланс на стоимость услуги (уменьшает долг). Принимает id пользователя, ИД услуги, ИД заказа, сумму.* <br/>
 Вызов: 
  ``` 
  POST /account/approveServiceFee
  ```
  
  Принимаемый JSON: 
  ``` 
  {
    "user-id": int,
    "service-id": int,
    "order-id": int,
    "fee": int
  }
  ```
  Возвращаемый JSON: 
  ``` 
  { 
    "account-id": int
    "service-id": int
    "order-id":   int
    "invoice":    int
    "status":     string
    "created-at": time.Time(),
    "updated-at": time.Time()
  } 
  ```
 ## Примечания: реализованы проверки на существование пользователя с указанным идентификатором, последний статус записи с теми же параметрами. </br>



*Доп. задание 1:*

Бухгалтерия раз в месяц просит предоставить сводный отчет по всем пользователем, с указанием сумм выручки по каждой из предоставленной услуги для расчета и уплаты налогов.

Задача: реализовать метод для получения месячного отчета. На вход: год-месяц. На выходе ссылка на CSV файл.

Пример отчета:

название услуги 1;общая сумма выручки за отчетный период

название услуги 2;общая сумма выручки за отчетный период

*Доп. задание 2:*

Пользователи жалуются, что не понимают за что были списаны (или зачислены) средства. 

Задача: необходимо предоставить метод получения списка транзакций с комментариями откуда и зачем были начислены/списаны средства с баланса. Необходимо предусмотреть пагинацию и сортировку по сумме и дате. 
